name: Setup macOS environment
description: >-
  Installs necessary packages via Homebrew.

inputs: {} # nothing?

outputs:
  opt_dir:
    value: ${{ steps.brew.outputs.opt_dir }}

runs:
  using: composite

  steps:
    - name: brew
      id: brew
      shell: bash
      run: |
        formulae=(gmp libffi openssl@1.1 zlib autoconf automake libtool readline)
        brew install --quiet "${formulae[@]}"
        keg_only=($(brew info --json "${formulae[@]}" |
          sed -n '/^ *"name": "\(.*\)",.*/{s//\1/;h;};/^ *"keg_only": true/{g;p;}'
        ))
        echo opt_dir="--with-opt-dir=$(brew --prefix)" >> $GITHUB_OUTPUT
        conf=
        for lib in ${{ steps.brew.outputs.keg_only }}; do
          conf="${conf:+$conf } --with-${lib%@*}-dir=$(brew --prefix $lib)"
        done
        echo CONFIGURE_ARGS="${conf}" >> $GITHUB_ENV

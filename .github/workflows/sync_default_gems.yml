name: Sync default gems
on:
  workflow_dispatch:
    inputs:
      gem:
        required: true
        description: 'Name of the gem to be synchronized'
        type: string
      before:
        required: true
        description: 'Gem commit SHA before sync'
        type: string
      after:
        required: true
        description: 'Gem commit SHA after sync'
        type: string

jobs:
  sync_default_gems:
    name: Sync default gems

    permissions:
      contents: write # for Git to git push

    runs-on: ubuntu-latest

    if: ${{ github.repository == 'ruby/ruby' }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        name: Check out ruby/ruby
        with:
          fetch-depth: 999999 # Fetch all history to follow past renames. Not using 0 to avoid fetching tags/branches.
          token: ${{ github.repository == 'ruby/ruby' && secrets.MATZBOT_AUTO_UPDATE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Increase rename limit
        run: git config merge.renameLimit 999999

      - name: Run tool/sync_default_gems.rb
        id: sync
        run: |
          ruby_before=$(git rev-parse HEAD)
          set -x
          ruby tool/sync_default_gems.rb "${gem_name}" "${gem_before}..${gem_after}"
          if [[ "$(git rev-parse HEAD)" != "$ruby_before" ]]; then
            echo update=true >> $GITHUB_OUTPUT
          fi
        env:
          gem_name: ${{ github.event.inputs.gem }}
          gem_before: ${{ github.event.inputs.before }}
          gem_after: ${{ github.event.inputs.after }}
          EMAIL: svn-admin@ruby-lang.org
          GIT_AUTHOR_NAME: git
          GIT_COMMITTER_NAME: git

      - name: Push
        run: |
          git pull --ff-only origin ${GITHUB_REF#refs/heads/}
          git push origin ${GITHUB_REF#refs/heads/}
        if: ${{ steps.sync.outputs.update }}

      - uses: ./.github/actions/slack
        with:
          SLACK_WEBHOOK_URL: ${{ secrets.SIMPLER_ALERTS_URL }} # ruby-lang slack: ruby/simpler-alerts-bot
        if: ${{ failure() }}

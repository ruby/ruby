name: bundled_gems

on:
  schedule:
    - cron: '45 6 * * *'

jobs:
  update:
    if: ${{ github.repository == 'ruby/ruby' }}
    name: update ${{ github.workflow }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ruby/ruby-ci-image:ubuntu-21.10
      options: --user root
    steps:
      - name: Set ENV
        run: |
          echo "GNUMAKEFLAGS=-j$((1 + $(nproc --all)))" >> $GITHUB_ENV

      - uses: actions/checkout@v2

      - name: Update ${{ github.workflow }}
        run: |
          ruby -i~ tool/update-bundled_gems.rb gems/${{ github.workflow }}

      - name: Check diffs
        id: diff
        run: |
          git diff --no-ext-diff --ignore-submodules --exit-code
        continue-on-error: true

      - name: Build
        run: |
          ./autogen.sh
          ./configure -C --disable-install-doc
          make
        if: ${{ steps.diff.outcome == 'failure' }}

      - name: Test bundled gems
        run: |
          make -s test-bundled-gems
        timeout-minutes: 30
        env:
          RUBY_TESTOPTS: "-q --tty=no"
          TEST_BUNDLED_GEMS_ALLOW_FAILURES: ""
        if: ${{ steps.diff.outcome == 'failure' }}

      - name: Commit
        run: |
          git commit --message="Update ${{ github.workflow }} at $(date +%F)" gems/${{ github.workflow }}
          git pull --ff-only origin ${GITHUB_REF#refs/heads/}
          git push origin ${GITHUB_REF#refs/heads/}
        env:
          EMAIL: svn-admin@ruby-lang.org
          GIT_AUTHOR_NAME: git
          GIT_COMMITTER_NAME: git
        if: ${{ steps.diff.outcome == 'failure' }}
